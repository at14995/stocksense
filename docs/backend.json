{
  "entities": {
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user of the Stock Sense application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the user entity."
        },
        "email": {
          "type": "string",
          "description": "The user's email address.",
          "format": "email"
        },
        "displayName": {
          "type": "string",
          "description": "The user's display name."
        },
        "photoURL": {
          "type": "string",
          "description": "URL of the user's profile picture.",
          "format": "uri"
        }
      },
      "required": [
        "id",
        "email",
        "displayName"
      ]
    },
    "Stock": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Stock",
      "type": "object",
      "description": "Represents a stock listed in the marketplace.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the stock entity."
        },
        "ticker": {
          "type": "string",
          "description": "The stock ticker symbol (e.g., AAPL)."
        },
        "name": {
          "type": "string",
          "description": "The full name of the company (e.g., Apple Inc.)."
        },
        "currentPrice": {
          "type": "number",
          "description": "The current price of the stock."
        },
        "description": {
          "type": "string",
          "description": "A description of the stock."
        }
      },
      "required": [
        "id",
        "ticker",
        "name",
        "currentPrice"
      ]
    },
    "SentimentAnalysis": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "SentimentAnalysis",
      "type": "object",
      "description": "Represents the sentiment analysis result for a stock.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the sentiment analysis result."
        },
        "stockId": {
          "type": "string",
          "description": "Reference to Stock. (Relationship: Stock 1:N SentimentAnalysis)"
        },
        "analysisDate": {
          "type": "string",
          "description": "The date and time the sentiment analysis was performed.",
          "format": "date-time"
        },
        "sentimentScore": {
          "type": "number",
          "description": "A numerical score representing the sentiment (e.g., -1 to 1)."
        },
        "summary": {
          "type": "string",
          "description": "A textual summary of the sentiment analysis."
        }
      },
      "required": [
        "id",
        "stockId",
        "analysisDate",
        "sentimentScore",
        "summary"
      ]
    },
    "Alert": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Alert",
      "type": "object",
      "description": "Represents a price alert for a stock.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the alert entity."
        },
        "ownerUid": {
          "type": "string",
          "description": "The UID of the user who owns the alert."
        },
        "symbol": {
          "type": "string",
          "description": "The stock symbol for the alert."
        },
        "condition": {
          "type": "string",
          "enum": ["above", "below"],
          "description": "The condition for the alert to trigger ('above' or 'below')."
        },
        "target": {
          "type": "number",
          "description": "The target price for the alert."
        },
        "status": {
          "type": "string",
          "enum": ["active", "triggered", "archived"],
          "description": "The current status of the alert."
        }
      },
      "required": ["ownerUid", "symbol", "condition", "target", "status"]
    },
    "Post": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Post",
      "description": "A post made by a user in the social feed.",
      "type": "object",
      "properties": {
        "ownerUid": { "type": "string", "description": "The UID of the user who created the post." },
        "username": { "type": "string", "description": "The display name of the user who created the post." },
        "content": { "type": "string", "description": "The text content of the post.", "maxLength": 500 },
        "tickers": { "type": "array", "items": { "type": "string" }, "description": "A list of stock tickers mentioned in the post." },
        "sentiment": { "type": "string", "enum": ["bullish", "bearish", "neutral"], "description": "The user's sentiment towards the mentioned tickers." },
        "likeCount": { "type": "number", "description": "The number of likes the post has received." },
        "commentCount": { "type": "number", "description": "The number of comments on the post." },
        "createdAt": { "type": "string", "format": "date-time" },
        "updatedAt": { "type": "string", "format": "date-time" }
      },
      "required": ["ownerUid", "username", "content", "sentiment", "likeCount", "commentCount", "createdAt"]
    },
    "Comment": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Comment",
      "description": "A comment on a post.",
      "type": "object",
      "properties": {
        "postId": { "type": "string", "description": "The ID of the post this comment belongs to." },
        "ownerUid": { "type": "string", "description": "The UID of the user who created the comment." },
        "username": { "type": "string", "description": "The display name of the user who created the comment." },
        "content": { "type": "string", "description": "The text content of the comment.", "maxLength": 250 },
        "createdAt": { "type": "string", "format": "date-time" }
      },
      "required": ["postId", "ownerUid", "username", "content", "createdAt"]
    },
    "Follow": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Follow",
      "description": "Represents a follow relationship between two users.",
      "type": "object",
      "properties": {
        "followerUid": { "type": "string", "description": "The UID of the user who is following." },
        "followingUid": { "type": "string", "description": "The UID of the user being followed." },
        "createdAt": { "type": "string", "format": "date-time" }
      },
      "required": ["followerUid", "followingUid", "createdAt"]
    },
    "Ticket": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Ticket",
      "description": "A support ticket submitted by a user.",
      "type": "object",
      "properties": {
        "ownerUid": { "type": "string" },
        "subject": { "type": "string", "maxLength": 120 },
        "message": { "type": "string", "maxLength": 2000 },
        "status": { "type": "string", "enum": ["open", "in_progress", "resolved", "closed"] },
        "priority": { "type": "string", "enum": ["low", "normal", "high"] },
        "adminAssigneeUid": { "type": "string" },
        "resolutionNotes": { "type": "string" },
        "lastActor": { "type": "string", "enum": ["user", "admin"] },
        "createdAt": { "type": "string", "format": "date-time" },
        "updatedAt": { "type": "string", "format": "date-time" }
      },
      "required": ["ownerUid", "subject", "message", "status", "priority", "lastActor", "createdAt", "updatedAt"]
    },
    "Role": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Role",
      "description": "Assigns a role (e.g., admin) to a user.",
      "type": "object",
      "properties": {
        "uid": { "type": "string" },
        "role": { "type": "string", "enum": ["admin", "user"] }
      },
      "required": ["uid", "role"]
    },
    "Notification": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Notification",
      "description": "An in-app notification for a user.",
      "type": "object",
      "properties": {
        "uid": { "type": "string" },
        "type": { "type": "string" },
        "title": { "type": "string" },
        "body": { "type": "string" },
        "href": { "type": "string", "format": "uri" },
        "read": { "type": "boolean" },
        "createdAt": { "type": "string", "format": "date-time" }
      },
      "required": ["uid", "type", "title", "body", "read", "createdAt"]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": { "$ref": "#/backend/entities/User" },
          "description": "Stores user profile information. Path-based ownership is enforced via the {userId} parameter.",
          "params": [{ "name": "userId", "description": "The unique identifier of the user, corresponding to their Firebase Auth UID." }]
        }
      },
      {
        "path": "/stocks/{stockId}",
        "definition": {
          "entityName": "Stock",
          "schema": { "$ref": "#/backend/entities/Stock" },
          "description": "Stores stock information. No ownership constraints; accessible by all users.",
          "params": [{ "name": "stockId", "description": "The unique identifier for the stock." }]
        }
      },
      {
        "path": "/stocks/{stockId}/sentimentAnalysis/{sentimentAnalysisId}",
        "definition": {
          "entityName": "SentimentAnalysis",
          "schema": { "$ref": "#/backend/entities/SentimentAnalysis" },
          "description": "Stores sentiment analysis results for a specific stock. Includes denormalized stockId to allow listing all sentiments for a stock without a collection group query.",
          "params": [
            { "name": "stockId", "description": "The unique identifier of the stock." },
            { "name": "sentimentAnalysisId", "description": "The unique identifier for the sentiment analysis result." }
          ]
        }
      },
      {
        "path": "/alerts/{alertId}",
        "definition": {
          "entityName": "Alert",
          "schema": { "$ref": "#/backend/entities/Alert" },
          "description": "Stores user-specific price alerts. Path-based ownership is enforced.",
          "params": [{ "name": "alertId", "description": "The unique identifier for the alert." }]
        }
      },
      {
        "path": "/posts/{postId}",
        "definition": {
          "entityName": "Post",
          "schema": { "$ref": "#/backend/entities/Post" },
          "description": "Stores social feed posts from users/analysts.",
          "params": [{ "name": "postId", "description": "The unique identifier for the post." }]
        }
      },
      {
        "path": "/comments/{commentId}",
        "definition": {
          "entityName": "Comment",
          "schema": { "$ref": "#/backend/entities/Comment" },
          "description": "Stores comments on posts.",
          "params": [{ "name": "commentId", "description": "The unique identifier for the comment." }]
        }
      },
      {
        "path": "/follows/{followId}",
        "definition": {
          "entityName": "Follow",
          "schema": { "$ref": "#/backend/entities/Follow" },
          "description": "Stores follow relationships between users.",
          "params": [{ "name": "followId", "description": "The unique identifier for the follow relationship." }]
        }
      },
      {
        "path": "/tickets/{ticketId}",
        "definition": {
          "entityName": "Ticket",
          "schema": { "$ref": "#/backend/entities/Ticket" },
          "description": "Stores support tickets submitted by users.",
          "params": [{ "name": "ticketId", "description": "The unique identifier for the support ticket." }]
        }
      },
      {
        "path": "/roles/{userId}",
        "definition": {
          "entityName": "Role",
          "schema": { "$ref": "#/backend/entities/Role" },
          "description": "Stores user roles, primarily for admin access.",
          "params": [{ "name": "userId", "description": "The UID of the user." }]
        }
      },
       {
        "path": "/notifications/{notificationId}",
        "definition": {
          "entityName": "Notification",
          "schema": { "$ref": "#/backend/entities/Notification" },
          "description": "Stores in-app notifications for users.",
          "params": [{ "name": "notificationId", "description": "The unique identifier for the notification." }]
        }
      }
    ],
    "reasoning": "The Firestore structure is designed to manage user data, stock information, and sentiment analysis results in a secure, scalable, and debuggable manner. It focuses on authorization independence and structural segregation.  User data is stored under `/users/{userId}` guaranteeing path-based ownership. Stock data is stored globally.  Sentiment analysis results are stored in a subcollection of Stocks. This structure avoids hierarchical authorization dependencies by NOT relying on `get()` calls in security rules. All rules rely solely on `request.auth.uid` or the data present in the document being validated. All collections are designed for homogeneous security posture.\n\nThis structure supports the required QAPs by:\n\n1.  **Secure List Operations:** Segregating data into collections with clear ownership rules (e.g., `/users/{userId}`) allows for secure list operations based on user ID. The `/stocks` collection may require additional constraints (e.g., pagination, filtering) to manage large datasets, but its rules remain simple.\n2.  **Authorization Independence:** No `get()` calls are required in the rules, ensuring atomic operations are possible.\n3.  **Debuggability:** The structure makes the authorization intent clear by using standard patterns (Path-Based Ownership).\n4.  **DBAC:** Roles will need to be stored inside the user document. Example `isAdmin: true | false`."
  }
}
