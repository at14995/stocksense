/**
 * @fileoverview Firestore Security Rules for Stock Sense Application
 *
 * Core Philosophy:
 * This ruleset enforces a combination of user-ownership and role-based access across the application's modules.
 * It ensures that users can only access their own data unless they have administrative privileges or the data is public.
 *
 * Data Structure:
 * - /users/{userId}: Private user data.
 * - /watchlists/{watchlistId}: User-owned watchlists.
 * - /alerts/{alertId}: User-owned price alerts.
 * - /posts/{postId}: Public posts by analysts.
 * - /comments/{commentId}: Public comments on posts.
 * - /tickets/{ticketId}: Support tickets, accessible by owner and admins.
 * - /roles/{userId}: Admin role definitions.
 * - /notifications/{notificationId}: User-specific notifications.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Users can create their own profile. They can only read, update, or delete their own existing profile.
     */
    match /users/{userId} {
      allow create: if request.auth != null && request.auth.uid == userId;
      allow read, update, delete: if request.auth != null && request.auth.uid == userId;
    }

    /**
     * @description Publicly readable stock data.
     */
    match /stocks/{stockId} {
      allow read, list: if request.auth != null;
      allow write: if false; // Managed by a trusted backend process.
    }
    
    /**
     * @description Publicly readable sentiment analysis data.
     */
    match /stocks/{stockId}/sentimentAnalysis/{sentimentId} {
      allow read, list: if request.auth != null;
      allow write: if false; // Managed by a trusted backend process.
    }

    /**
     * @description User can create, read, update, and delete their own watchlists.
     */
    match /watchlists/{watchlistId} {
      // On create, ownerUid is in the request body.
      allow create: if request.auth != null && request.resource.data.ownerUid == request.auth.uid;
      // For existing documents, ownerUid is on the stored document.
      allow read, update, delete: if request.auth != null && resource.data.ownerUid == request.auth.uid;
    }

    /**
     * @description User can create, read, update, and delete their own alerts.
     */
    match /alerts/{alertId} {
      allow create: if request.auth != null && request.resource.data.ownerUid == request.auth.uid;
      allow read, update, delete: if request.auth != null && resource.data.ownerUid == request.auth.uid;
    }

    /**
     * @description Posts are readable by any authenticated user.
     * Only verified analysts with an active subscription can create posts.
     * Only the owner can update or delete their own post.
     */
    match /posts/{postId} {
      allow list, read: if request.auth != null;
      allow create: if request.auth != null
                    && request.resource.data.ownerUid == request.auth.uid
                    && get(/databases/$(database)/documents/roles/$(request.auth.uid)).data.role == 'analyst'
                    && get(/databases/$(database)/documents/roles/$(request.auth.uid)).data.isVerified == true
                    && get(/databases/$(database)/documents/roles/$(request.auth.uid)).data.subscriptionActive == true;
      allow update, delete: if request.auth != null && resource.data.ownerUid == request.auth.uid;
    }

    /**
     * @description Comments are readable by any authenticated user.
     * Any authenticated user can create a comment. Only the owner can delete it.
     */
    match /comments/{commentId} {
      allow list, read: if request.auth != null;
      allow create: if request.auth != null;
      allow delete: if request.auth != null && resource.data.ownerUid == request.auth.uid;
    }

    /**
     * @description Users can manage their own support tickets.
     * Admins can access all tickets.
     */
    match /tickets/{ticketId} {
       allow create: if request.auth != null && request.resource.data.ownerUid == request.auth.uid;
       allow read, update, delete: if request.auth != null && 
         (resource.data.ownerUid == request.auth.uid || 
          get(/databases/$(database)/documents/roles/$(request.auth.uid)).data.role == 'admin');
    }
    
    /**
     * @description Role documents are only readable by admins.
     * Analysts can read their own role.
     */
    match /roles/{userId} {
      allow read: if request.auth != null && (get(/databases/$(database)/documents/roles/$(request.auth.uid)).data.role == 'admin' || request.auth.uid == userId);
      allow write: if false; // Roles should be managed manually or by a trusted backend.
    }

    /**
     * @description Users can create, read, and write their own notifications.
     */
    match /notifications/{notificationId} {
      allow create: if request.auth != null && request.resource.data.uid == request.auth.uid;
      allow read, update, delete: if request.auth != null && resource.data.uid == request.auth.uid;
    }
  }
}
